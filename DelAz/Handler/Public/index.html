<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ZipDrop – instant zip hosting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://identity.vercel.com/widget.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#0d1117;color:#c9d1d9;display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:center;}
    #drop{border:2px dashed #30363d;border-radius:12px;padding:60px 80px;text-align:center;transition:.2s;}
    #drop.dragover{border-color:#58a6ff;background:#161b22;}
    #msg{margin-top:12px;font-size:14px;color:#8b949e;}
    #user{margin-bottom:20px;font-size:16px;}
    a{color:#58a6ff;}
    button{padding:8px 14px;border:none;border-radius:6px;background:#238636;color:#fff;font-size:14px;cursor:pointer;}
  </style>
</head>
<body>
  <div id="user">Checking login…</div>
  <div id="drop" style="display:none;">
    <h2>Drop zip here</h2>
    <p id="msg">or click to choose</p>
    <input type="file" id="inp" accept=".zip" style="display:none">
  </div>

  <script>
    const drop = document.getElementById('drop');
    const inp  = document.getElementById('inp');
    const msg  = document.getElementById('msg');
    const user = document.getElementById('user');

    window.vercelIdentity.on('login',()=>location.reload());
    window.vercelIdentity.on('logout',()=>location.reload());

    fetch('/api/whoami').then(r=>r.json()).then(d=>{
      if(d.user){
        user.innerHTML=`Hello <b>${d.user.email}</b> · <a href="#" onclick="window.vercelIdentity.logout();return false">logout</a>`;
        drop.style.display='block';
      }else{
        user.innerHTML='Please <button onclick="window.vercelIdentity.login()">Sign up / Log in</button>';
      }
    });

    drop.onclick=()=>inp.click();
    inp.onchange=e=>handle(e.target.files[0]);
    ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
      drop.addEventListener(ev,preventDefaults,false);
      document.body.addEventListener(ev,preventDefaults,false);
    });
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.add('dragover'),false));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.remove('dragover'),false));
    drop.addEventListener('drop',e=>handle(e.dataTransfer.files[0]),false);
    function preventDefaults(e){e.preventDefault();e.stopPropagation();}

    async handle=async(file)=>{
      if(!file||!file.name.endsWith('.zip'))return msg.textContent='Only .zip files';
      msg.textContent='Uploading…';
      const res=await fetch('/api/upload',{method:'POST',body:file,headers:{'x-file-name':file.name}});
      const{url}=await res.json();
      location.href='/success.html?url='+encodeURIComponent(url);
    };
  </script>
</body>
</html>